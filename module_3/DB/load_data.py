import psycopg
from psycopg import OperationalError
from .connection import get_db_connection
from pathlib import Path
import json

class DataLoader:
    """
    A class to handle the process of reading applicant data from a JSON file
    and loading it into a PostgreSQL database.
    """

    def __init__(self):
        """
        Initializes the class by setting up a database connection and the path to the JSON file.
        """

        # Create a connection to the PostgreSQL database
        self.connection = get_db_connection()
        # Full path to the JSON data file
        self.json_path = Path(__file__).parent / 'applicant_data.json'
    
    def load_data(self):
        """Load parsed data from a JSON file.
            
            Returns:
                list[dict]: A list of dictionaries with applicants records.
        """
        try:
            with open(self.json_path, 'r', encoding='utf-8') as f:
                return json.load(f)
        except Exception as e:
            print(f"Error loading data: {e}")
            return None

    def create_table(self):
        """Create the applicants table in the database if it does not exist."""
        # Enable autocommit to ensure changes are saved
        self.connection.autocommit = True

        try:
            # Open cursor to perform database operations
            with self.connection.cursor() as cur:
                # Execute table creation
                cur.execute("""
                            CREATE TABLE IF NOT EXISTS applicants (
                                id int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                                program TEXT,
                                comments TEXT,
                                date_added DATE,
                                url TEXT,
                                status TEXT,
                                term TEXT,
                                us_or_international TEXT,
                                gpa FLOAT,
                                gre FLOAT,
                                gre_v FLOAT,
                                gre_aw FLOAT,
                                degree TEXT
                            );
                            """)
                
                # Commit changes
                self.connection.commit()

        except psycopg.OperationalError as e:
            # Print error if something goes wrong with table creation
            print(f"The error '{e}' occurred")
    
    def insert_to_table(self, data):
        """Insert a list of applicant records into the DB table if it is currently empty.
        
        Arguments:
            data (list[dict]): A list of applicant records to insert into the DB.
        """
        insert_query = """
                        INSERT INTO applicants (
                        program, comments, date_added, url, status, term,
                        us_or_international, gpa, gre, gre_v, gre_aw, degree
                        ) VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
                        """
        
        try:
            with self.connection.cursor() as cur:
                # Check if table already has rows
                cur.execute("SELECT COUNT(*) FROM applicants;")
                count_rows = cur.fetchone()[0]

                if count_rows > 0:
                    # Table already includes data - close connection
                    self.connection.close()
                    return

                # Iterate over each record and insert into the table
                for row in data:
                    values = (
                            row.get("program"),
                            row.get("comment"),
                            row.get("date_added"),
                            row.get("url"),
                            row.get("status"),
                            row.get("term"),
                            row.get("us_or_international"),
                            row.get("GPA"),
                            row.get("GRE"),
                            row.get("GRE_V"),
                            row.get("GRE_AW"),
                            row.get("degree")
                        )

                    cur.execute(insert_query, values)

            # Enable autocommit to ensure changes are saved
            self.connection.autocommit = True 

        except psycopg.OperationalError as e:
            # Print error if insertion fails
            print(f"The error '{e}' occurred")
        
        # Close connection
        self.connection.close()
    
def run_loader():
    """
    Run the full data loading process:
    - Create the applicants table (if it doesn't exist)
    - Load data from the JSON file
    - Insert the data into the database (if the table is empty)
    """
    
    # Instantiate the DataLoader class
    loader = DataLoader()

    # Create the applicants table in the database
    loader.create_table()

    # Load applicant data from the JSON file
    applicants_info = loader.load_data()

    # Insert the loaded data into the database table
    loader.insert_to_table(applicants_info)

# Main execution block
if __name__ == "__main__":
    run_loader()